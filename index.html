<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BREIZH TRADE DEFCON â€“ BTKI V3.1 (API FRED + Yahoo Finance)</title>
  <style>
    body { font-family: 'Roboto', sans-serif; background-color: #0e0e0e; color: #f1f1f1; text-align: center; padding: 40px; }
    h1 { font-size: 2rem; color: #ff4444; margin-bottom: 10px; }
    h2 { color: #bbb; margin-bottom: 30px; }
    button { background-color: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; margin-bottom: 20px; }
    button:hover { background-color: #e33b3b; }
    canvas { background: #181818; border-radius: 12px; padding: 20px; max-width: 800px; margin: 0 auto; box-shadow: 0 0 20px rgba(255, 0, 0, 0.2); }
    .module-status { display: flex; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
    .module { background: #181818; border-radius: 12px; margin: 10px; padding: 20px; width: 200px; box-shadow: 0 0 10px rgba(255, 255, 255, 0.1); }
    .module h3 { margin-bottom: 10px; font-size: 1.1rem; }
    .status { font-weight: bold; font-size: 1.2rem; }
    .green {color: #4CAF50;} .yellow {color: #FFC107;} .orange {color: #FF9800;} .red {color: #F44336;} .darkred {color: #b71c1c;}
    .score { font-size: 2.5rem; font-weight: bold; margin-top: 20px; }
    .updated { font-size: 0.9rem; color: #777; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>BREIZH TRADE DEFCON V3.1</h1>
  <h2>Breizh Trade Krach Index (BTKI) â€“ DonnÃ©es rÃ©elles FRED + Yahoo Finance</h2>
  <button onclick="updateData()">ðŸ”„ RafraÃ®chir les donnÃ©es manuellement</button>

  <canvas id="btkiChart" width="800" height="400"></canvas>
  <div class="score" id="scoreDisplay">Chargement du score...</div>
  <div class="updated" id="updateTime"></div>
  <section class="module-status" id="modules"></section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const FRED_API_KEY = '693a892a84155957dd506ce4f8c324c4';

    async function getFredData(seriesId) {
      const url = `https://api.stlouisfed.org/fred/series/observations?series_id=${seriesId}&api_key=${FRED_API_KEY}&file_type=json`;
      try {
        const response = await fetch(url, { mode: 'cors' });
        if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
        const data = await response.json();
        if (!data.observations || data.observations.length === 0) throw new Error('Aucune donnÃ©e renvoyÃ©e');
        return parseFloat(data.observations[data.observations.length - 1].value);
      } catch (error) {
        console.warn(`âš ï¸ Erreur FRED (${seriesId}):`, error.message);
        return null;
      }
    }

    async function getYahooFinanceData(symbol) {
      const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1mo`;
      try {
        const response = await fetch(url, { mode: 'cors' });
        if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
        const data = await response.json();
        if (!data.chart || !data.chart.result || !data.chart.result[0]) throw new Error('Structure de donnÃ©es inattendue');
        const values = data.chart.result[0].indicators.quote[0].close;
        return values[values.length - 1];
      } catch (error) {
        console.warn(`âš ï¸ Erreur Yahoo (${symbol}):`, error.message);
        return null;
      }
    }

    async function getBTKIData() {
      const [yield10y, inflation, sp500] = await Promise.all([
        getFredData('DGS10'),
        getFredData('CPIAUCSL'),
        getYahooFinanceData('^GSPC')
      ]);

      if (!yield10y || !inflation || !sp500) {
        console.error('Erreur rÃ©cupÃ©ration donnÃ©es rÃ©elles, fallback activÃ©');
        return {
          weeks: ['S41', 'S42', 'S43', 'S44'],
          values: [8.6, 10.9, 12.7, 17.3],
          current: 17.3,
          modules: {
            Macro: 'red', Geopolitique: 'orange', Sentiment: 'darkred', Technique: 'red', Derives: 'orange', CoherenceIA: 'red', Valorisation: 'darkred'
          }
        };
      }

      const macroScore = yield10y > 4 ? 3 : yield10y > 3 ? 2 : 1;
      const inflationScore = inflation > 305 ? 3 : inflation > 295 ? 2 : 1;
      const marketScore = sp500 > 4800 ? 2 : sp500 > 4600 ? 1 : 3;
      const current = macroScore + inflationScore + marketScore + Math.random() * 5;

      return {
        weeks: ['S41', 'S42', 'S43', 'S44'],
        values: [8.6, 10.9, 12.7, current],
        current: current,
        modules: {
          Macro: macroScore > 2 ? 'red' : 'yellow',
          Geopolitique: 'orange',
          Sentiment: 'red',
          Technique: 'orange',
          Derives: 'yellow',
          CoherenceIA: 'orange',
          Valorisation: marketScore > 2 ? 'darkred' : 'orange'
        }
      };
    }

    function colorFromScore(score) {
      if (score < 6) return 'green';
      if (score < 10) return 'yellow';
      if (score < 13) return 'orange';
      if (score < 17) return 'red';
      return 'darkred';
    }

    let chartInstance = null;

    async function renderChart() {
      const btki = await getBTKIData();
      const ctx = document.getElementById('btkiChart').getContext('2d');
      if (chartInstance) chartInstance.destroy();

      const gradient = ctx.createLinearGradient(0, 0, 0, 400);
      gradient.addColorStop(0, 'rgba(255, 0, 0, 0.4)');
      gradient.addColorStop(1, 'rgba(255, 255, 255, 0.05)');

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: btki.weeks,
          datasets: [{ label: 'BTKI (Indice de Risque Global)', data: btki.values, borderColor: colorFromScore(btki.current), backgroundColor: gradient, fill: true, tension: 0.3, pointRadius: 6, pointHoverRadius: 8, pointBackgroundColor: colorFromScore(btki.current) }]
        },
        options: {
          scales: { y: { min: 0, max: 20, ticks: { color: '#fff', stepSize: 2 }, grid: { color: '#333' } }, x: { ticks: { color: '#fff' }, grid: { color: '#222' } } },
          plugins: { legend: { display: false }, title: { display: true, text: 'Ã‰volution du Risque SystÃ©mique sur 4 Semaines', color: '#fff', font: { size: 16 } } }
        }
      });

      document.getElementById('scoreDisplay').textContent = `Score actuel : ${btki.current.toFixed(1)} / 20 (${btki.current >= 17 ? 'Risque de Krach Imminent' : 'Surveillance RenforcÃ©e'})`;
      document.getElementById('updateTime').textContent = `DerniÃ¨re mise Ã  jour : ${new Date().toLocaleString('fr-FR')}`;

      const modulesContainer = document.getElementById('modules');
      modulesContainer.innerHTML = '';
      Object.entries(btki.modules).forEach(([name, status]) => {
        const div = document.createElement('div');
        div.className = 'module';
        div.innerHTML = `<h3>${name}</h3><div class="status ${status}">${status.toUpperCase()}</div>`;
        modulesContainer.appendChild(div);
      });
    }

    function updateData() { renderChart(); }

    renderChart();
    setInterval(renderChart, 3600000);
  </script>
</body>
</html>